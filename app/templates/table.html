<!DOCTYPE html>
<html lang="fr" style="position: absolute;top: 50%;transform: translateY(-50%);width: 100%;background-color: #F2F3F8; font-family: -apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Helvetica,Arial,sans-serif;">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Leave Workflow Management</title>
  <script src="{{ url_for('static', filename='libs/tailwindcss.js') }}"></script>
  <script>
    const ALPHA2_FRENCH = {
      "AD" : "Andorre",
      "AE" : "Émirats Arabes Unis",
      "AF" : "Afghanistan",
      "AG" : "Antigua-Et-Barbuda",
      "AI" : "Anguilla",
      "AL" : "Albanie",
      "AM" : "Arménie",
      "AO" : "Angola",
      "AP" : "Région Asie/Pacifique",
      "AQ" : "Antarctique",
      "AR" : "Argentine",
      "AS" : "Samoa Américaines",
      "AT" : "Autriche",
      "AU" : "Australie",
      "AW" : "Aruba",
      "AX" : "Îles Åland",
      "AZ" : "Azerbaïdjan",
      "BA" : "Bosnie-Herzégovine",
      "BB" : "Barbad",
      "BD" : "Bangladesh",
      "BE" : "Belgique",
      "BF" : "Burkina Faso",
      "BG" : "Bulgarie",
      "BH" : "Bahreïn",
      "BI" : "Burundi",
      "BJ" : "Bénin",
      "BL" : "Saint-Barthélemy",
      "BM" : "Bermudes",
      "BN" : "Brunei Darussalam",
      "BO" : "État Plurinational De Bolivie",
      "BQ" : "Bonaire, Saint-Eustache Et Saba",
      "BR" : "Brésil",
      "BS" : "Bahamas",
      "BT" : "Bhoutan",
      "BV" : "Île Bouvet",
      "BW" : "Botswana",
      "BY" : "Biélorussie",
      "BZ" : "Belize",
      "CA" : "Canada",
      "CC" : "Îles Cocos",
      "CD" : "République Démocratique Du Congo",
      "CF" : "République Centrafricaine",
      "CG" : "Congo",
      "CH" : "Suisse",
      "CI" : "Côte D'Ivoire",
      "CK" : "Îles Cook",
      "CL" : "Chili",
      "CM" : "Cameroun",
      "CN" : "Chine",
      "CO" : "Colombie",
      "CR" : "Costa Rica",
      "CU" : "Cuba",
      "CV" : "Cap-Vert",
      "CW" : "Curaçao",
      "CX" : "Île Christmas",
      "CY" : "Chypre",
      "CZ" : "République Tchèque",
      "DE" : "Allemagne",
      "DJ" : "Djibouti",
      "DK" : "Denmark",
      "DM" : "Dominique",
      "DO" : "République Dominicaine",
      "DZ" : "Algérie",
      "EC" : "Équateur",
      "EE" : "Estonie",
      "EG" : "Égypte",
      "EH" : "Sahara Occidental",
      "ER" : "Érythrée",
      "ES" : "Espagne",
      "ET" : "Éthiopie",
      "EU" : "Europe",
      "FI" : "Finlande",
      "FJ" : "Fidji",
      "FK" : "Îles Malouines",
      "FM" : "États Fédérés De Micronésie",
      "FO" : "Îles Féroé",
      "FR" : "France",
      "GA" : "Gabon",
      "GB" : "Royaume-Uni",
      "GD" : "Grenade",
      "GE" : "Géorgie",
      "GF" : "Guyane",
      "GG" : "Guernesey",
      "GH" : "Ghana",
      "GI" : "Gibraltar",
      "GL" : "Groenland",
      "GM" : "Gambie",
      "GN" : "Guinée",
      "GP" : "Guadeloupe",
      "GQ" : "Guinée Équatoriale",
      "GR" : "Grèce",
      "GS" : "Géorgie Du Sud-Et-Les Îles Sandwich Du Sud",
      "GT" : "Guatemala",
      "GU" : "Guam",
      "GW" : "Guinée-Bissau",
      "GY" : "Guyana",
      "HK" : "Hong Kong",
      "HM" : "Îles Heard-Et-MacDonald",
      "HN" : "Honduras",
      "HR" : "Croatie",
      "HT" : "Haïti",
      "HU" : "Hongrie",
      "ID" : "Indonésie",
      "IE" : "Irlande",
      "IL" : "Israël",
      "IM" : "Île De Man",
      "IN" : "Inde",
      "IO" : "Territoire Britannique De L'océan Indien",
      "IQ" : "Irak",
      "IR" : "République Islamique D'Iran",
      "IS" : "Islande",
      "IT" : "Italie",
      "JE" : "Jersey",
      "JM" : "Jamaïque",
      "JO" : "Jordanie",
      "JP" : "Japon",
      "KE" : "Kenya",
      "KG" : "Kirghizistan",
      "KH" : "Cambodge",
      "KI" : "Kiribati",
      "KM" : "Comores",
      "KN" : "Saint-Christophe-et-Niévès",
      "KP" : "République Populaire Démocratique De Corée",
      "KR" : "République De Corée",
      "KW" : "Koweït",
      "KY" : "Îles Caïmans",
      "KZ" : "Kazakhstan",
      "LA" : "République Démocratique Populaire Lao",
      "LB" : "Liban",
      "LC" : "Sainte-Lucie",
      "LI" : "Liechtenstein",
      "LK" : "Sri Lanka",
      "LR" : "Liberia",
      "LS" : "Lesotho",
      "LT" : "Lituanie",
      "LU" : "Luxembourg",
      "LV" : "Lettonie",
      "LY" : "Libye",
      "MA" : "Maroc",
      "MC" : "Monaco",
      "MD" : "République De Moldavie",
      "ME" : "Monténégro",
      "MF" : "Saint-Martin (Partie Française)",
      "MG" : "Madagascar",
      "MH" : "Îles Marshall",
      "MK" : "Macédoine",
      "ML" : "Mali",
      "MM" : "Birmanie",
      "MN" : "Mongolie",
      "MO" : "Macao",
      "MP" : "Îles Mariannes Du Nord",
      "MQ" : "Martinique",
      "MR" : "Mauritanie",
      "MS" : "Montserrat",
      "MT" : "Malte",
      "MU" : "Maurice",
      "MV" : "Maldives",
      "MW" : "Malawi",
      "MX" : "Mexique",
      "MY" : "Malaisie",
      "MZ" : "Mozambique",
      "NA" : "Namibie",
      "NC" : "Nouvelle-Calédonie",
      "NE" : "Niger",
      "NF" : "Île Norfolk",
      "NG" : "Nigéria",
      "NI" : "Nicaragua",
      "NL" : "Pays-Bas",
      "NO" : "Norvège",
      "NP" : "Népal",
      "NR" : "Nauru",
      "NU" : "Niue",
      "NZ" : "Nouvelle-Zélande",
      "OM" : "Oman",
      "PA" : "Panama",
      "PE" : "Pérou",
      "PF" : "Polynésie Française",
      "PG" : "Papouasie-Nouvelle-Guinée",
      "PH" : "Philippines",
      "PK" : "Pakistan",
      "PL" : "Pologne",
      "PM" : "Saint-Pierre-Et-Miquelon",
      "PN" : "Pitcairn",
      "PR" : "Porto Rico",
      "PS" : "Territoires Palestiniens Occupés",
      "PT" : "Portugal",
      "PW" : "Palaos",
      "PY" : "Paraguay",
      "QA" : "Qatar",
      "RE" : "Réunion",
      "RO" : "Roumanie",
      "RS" : "Serbie",
      "RU" : "Fédération De Russie",
      "RW" : "Rwanda",
      "SA" : "Arabie Saoudite",
      "SB" : "Îles Salomon",
      "SC" : "Seychelles",
      "SD" : "Soudan",
      "SE" : "Suède",
      "SG" : "Singapour",
      "SH" : "Sainte-Hélène",
      "SI" : "Slovénie",
      "SJ" : "Svalbard Et Jan Mayen",
      "SK" : "Slovaquie",
      "SL" : "Sierra Leone",
      "SM" : "Saint-Marin",
      "SN" : "Sénégal",
      "SO" : "Somalie",
      "SR" : "Suriname",
      "SS" : "Soudan Du Sud",
      "ST" : "Sao Tomé-Et-Principe",
      "SV" : "République Du Salvador",
      "SX" : "Saint-Martin (Partie Néerlandaise)",
      "SY" : "République Arabe Syrienne",
      "SZ" : "Swaziland",
      "TC" : "Îles Turks-Et-Caïcos",
      "TD" : "Tchad",
      "TF" : "Terres Australes Françaises",
      "TG" : "Togo",
      "TH" : "Thaïlande",
      "TJ" : "Tadjikistan",
      "TK" : "Tokelau",
      "TL" : "Timor-Leste",
      "TM" : "Turkménistan",
      "TN" : "Tunisie",
      "TO" : "Tonga",
      "TR" : "Turquie",
      "TT" : "Trinité-Et-Tobago",
      "TV" : "Tuvalu",
      "TW" : "Taïwan",
      "TZ" : "République-Unie De Tanzanie",
      "UA" : "Ukraine",
      "UG" : "Ouganda",
      "UM" : "Îles Mineures Éloignées Des États-Unis",
      "US" : "États-Unis",
      "UY" : "Uruguay",
      "UZ" : "Ouzbékistan",
      "VA" : "Saint-Siège (État De La Cité Du Vatican)",
      "VC" : "Saint-Vincent-Et-Les Grenadines",
      "VE" : "Venezuela",
      "VG" : "Îles Vierges Britanniques",
      "VI" : "Îles Vierges Des États-Unis",
      "VN" : "Viet Nam",
      "VU" : "Vanuatu",
      "WF" : "Wallis Et Futuna",
      "WS" : "Samoa",
      "YE" : "Yémen",
      "YT" : "Mayotte",
      "ZA" : "Afrique Du Sud",
      "ZM" : "Zambie",
      "ZW" : "Zimbabwe"
    }

    function ajusterLignes(page) {
        const nav =  document.querySelector("nav");
        if(page == "_-1"){
            if(nav.children[1].hasAttribute("aria-selected")) return;
            for(let i = 2; i < nav.children.length - 1; i++){
                if(nav.children[i].hasAttribute("aria-selected")){
                    page = parseInt(nav.children[i].textContent) - 1;
                    break;
                }
            }
        }
        else if (page == "_+1"){
            if(nav.children[nav.children.length - 2].hasAttribute("aria-selected")) return;
            for(let i = 1; i < nav.children.length - 2; i++){
                if(nav.children[i].hasAttribute("aria-selected")){
                    page = parseInt(nav.children[i].textContent) + 1;
                    break;
                }
            }
        }


      // On sélectionne le corps du tableau et ses lignes
      const tbody = document.querySelector("tbody");
      const lignes = Array.from(tbody.querySelectorAll("tr"));
  
      // On détermine l'espace disponible en partant du haut du conteneur jusqu'au bas de la fenêtre.
      const rect = tbody.getBoundingClientRect();
      const bodyRect = window.document.body.getBoundingClientRect();

      const topDiff = rect.top - bodyRect.top;
      const bottomDiff = bodyRect.bottom - rect.bottom;
      
      const espaceDisponible = window.innerHeight - topDiff - bottomDiff;
  
      // On récupère la hauteur d'une ligne (s'il y a au moins une ligne)
      if (lignes.length === 0) return;
      const hauteurLigne = lignes.filter(ligne => ligne.style.display == "")[0].offsetHeight;
  
      // Calcul du nombre maximum de lignes affichables sans dépasser la hauteur dispo.
      const nbMaxLignes = Math.floor(espaceDisponible / hauteurLigne);

      const nb_start = nbMaxLignes * (page - 1) + 1;
      const nb_end  = Math.min(nbMaxLignes * page, lignes.length);
  
      // On affiche uniquement les nbMaxLignes premières lignes, et on cache le reste.
      lignes.forEach((ligne, index) => {
        ligne.style.display = (index >= nb_start - 1 && index < nb_end) ? "" : "none";
      });
      
      // On affiche dans la console le nombre de lignes affichées (on ne peut pas afficher plus de lignes existantes).
      document.getElementById("nb_start").innerHTML = nb_start;
      document.getElementById("nb_end").innerHTML = nb_end;
      document.getElementById("nb_total").innerHTML = lignes.length;

        const nbButtons =  Math.min(Math.ceil(lignes.length / nbMaxLignes), 3);
        let lowerBound = page - 1;
        let upperBound = page - 1 + nbButtons - 1;
        if(lowerBound < 1){
            lowerBound += 1;
            upperBound += 1;
        }
        if(upperBound > Math.ceil(lignes.length / nbMaxLignes)){
            lowerBound -= 1;
            upperBound -= 1;
        }

        /** Delete all except previous and next */
        Array.from(nav.children).forEach(child => {
            if (child !== nav.firstElementChild && child !== nav.lastElementChild) {
                nav.removeChild(child);
            }
        });

        for(let i = lowerBound; i < upperBound + 1; i++){
            const button = document.createElement("button");
            if(i == page){
                button.className = "z-10 bg-blue-50 border-blue-500 text-blue-600 relative inline-flex items-center px-4 py-2 border text-sm font-medium";
                button.setAttribute("aria-selected", "");
            }
            else {
                button.className = "bg-white border-gray-300 text-gray-500 hover:bg-gray-50 relative inline-flex items-center px-4 py-2 border text-sm font-medium";
                button.removeAttribute("aria-selected");
            }

            button.textContent = i;
            button.onclick = () => ajusterLignes(i);

            nav.insertBefore(button, nav.children[nav.children.length - 1]);
        }
      }

      function formatTimespan(milliseconds) {
        const seconds = Math.floor(parseFloat(milliseconds / 1000));
        const units = [
            { label: "h", plural: "h", value: 3600 },
            { label: "min", plural: "min", value: 60 },
            { label: "s", plural: "s", value: 1 }
        ];
        
        let remainingSeconds = seconds;
        let result = [];

        for (let { label, plural, value } of units) {
            const count = Math.floor(remainingSeconds / value);
            remainingSeconds %= value;
            if (count > 0) {
                result.push(`${count} ${count > 1 ? plural : label}`);
            }
        }

        return result.join(" ") || "0 s";
    }

    function loadContent(){
      let data = JSON.parse("{{data.content}}".replace(/&#34;/g, '"').replace(/&#39;/g, "'"));

      document.getElementById("table-title").textContent = "{{data.title}}".replace(/&#34;/g, '"').replace(/&#39;/g, "'");

      const columns = ["timestamp", "ip", "country", "mode", "difficulty", "success", "time",  "word", "attemps", "count", "score"].filter(
        col => data.some(
          line => Object.keys(line).includes(col)
        )
      )
      const headCol =  document.getElementById("head-col");
      const tbody = document.querySelector("tbody");

      columns.forEach(col => {
        const th = document.createElement("th");
        th.setAttribute("scope", "col");
        th.className = "px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider";
        th.textContent = {
        "timestamp" : "date", 
        "ip" : "ip", 
        "country" : "pays", 
        "mode" : "mode", 
        "difficulty" : "difficulté", 
        "success" : "réussite", 
        "time" : "temps",  
        "word" : "mot", 
        "attemps" : "tentatives", 
        "count" : "serie", 
        "score" : "score"
        }[col];

        headCol.append(th);
      });

      // FRENCH TRANSLATION
      data = data.map(line => {
          if (Object.keys(line).includes("timestamp")){
            line["timestamp"] = new Date(line["timestamp"]).toLocaleDateString('fr-FR', {
                  weekday: 'long',
                  year: 'numeric',
                  month: 'long',
                  day: 'numeric',
                  hour: '2-digit',
                  minute: '2-digit',
                  second: '2-digit',
                  timeZoneName: 'short'
              }
            );
            line["timestamp"] = line["timestamp"][0].toUpperCase() + line["timestamp"].slice(1);
          }
          if (Object.keys(line).includes("mode")){
            line["mode"] = {
              "ai" : "Versus IA",
              "solo" : "Solo",
              "daily" : "Mot du jour"
            }[line["mode"]];
          }
          if (Object.keys(line).includes("country") && line["country"] !== null){
            line["country"] = ALPHA2_FRENCH[line["country"]];
          }
          if  (Object.keys(line).includes("time")){
            line["time"] = formatTimespan(line["time"]);
          }
          if (Object.keys(line).includes("difficulty")){
            line["difficulty"] = ["Facile", "Moyen", "Difficile", "Expert"][line["difficulty"]];
          }
          return line
      });

      let maxSizeColumns = columns.map(col => col.length);
      data.forEach(line => {
        const keys = Object.keys(line);
        columns.map(col => 
          keys.includes(col) ? line[col] : ""
        ).forEach((elmt, index) => {          
          maxSizeColumns[index] = Math.max(maxSizeColumns[index], elmt ? elmt.length : 0);
        });
      })
      
      data.forEach(line => {
        const tr = document.createElement("tr");
        tr.className = "hover:bg-gray-50";

        const keys = Object.keys(line);
        let i = 0;
        columns.map(col => 
          keys.includes(col) ? line[col] : ""
        ).forEach(elmt => {
          elmt = elmt == null ? "" : elmt;
          const td = document.createElement("td");
          td.className = i == 0 ? "px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900" : "px-6 py-4 whitespace-nowrap text-sm text-gray-500";

          if (typeof elmt === "boolean"){
            const spanElement = document.createElement("span");
            spanElement.className = "px-2 inline-flex text-sm leading-5 font-semibold rounded-full" + (elmt ? "bg-green-100 text-green-800"  : "bg-red-100 text-red-800");
            spanElement.innerHTML = "<pre>" + (elmt ? "Oui" : "Non") + "</pre>";

            td.append(spanElement);
          } else {
            td.innerHTML = "<pre>" + elmt + ' '.repeat(maxSizeColumns[i] - elmt.length) +  "</pre>";
          }

          i++;

          tr.append(td);
        });

        tbody.append(tr);
      })

      setTimeout(() => ajusterLignes(1), 0);
    }
  
    // Exécuter lors du chargement et du redimensionnement
    window.addEventListener("load", loadContent);
  </script>
  
</head>
<body>
  <div class="container mx-auto px-4 py-6">

    <!-- Page Header and Action Buttons -->
    <div class="flex flex-col md:flex-row md:items-center md:justify-between mb-6">
      <h1 class="text-2xl font-bold text-gray-800 mb-4 md:mb-0" id="table-title"></h1>
    </div>

    <!-- Table -->
    <div class="overflow-x-auto bg-white rounded-xl shadow">
      <table class="min-w-full divide-y divide-gray-200">
        <thead class="bg-gray-50">
          <tr id="head-col">
          </tr>
        </thead>
        <tbody class="bg-white divide-y divide-gray-200">
        </tbody>
      </table>
    </div>
    
    <!-- Pagination -->
    <div class="flex items-center justify-between mt-4">
      <div class="flex-1 flex justify-between sm:hidden">
        <a href="#" class="relative inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50">
          Previous
        </a>
        <a href="#" class="relative inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50">
          Next
        </a>
      </div>
      <div class="hidden sm:flex-1 sm:flex sm:items-center sm:justify-between">
        <div>
          <p class="text-sm text-gray-700">
            Showing <span class="font-medium" id="nb_start"></span> to <span class="font-medium" id="nb_end"></span> of <span class="font-medium" id="nb_total"></span> results
          </p>
        </div>
        <div>
          <nav class="relative z-0 inline-flex rounded-md shadow-sm -space-x-px" aria-label="Pagination">
            <button class="relative inline-flex items-center px-2 py-2 rounded-l-md border border-gray-300 bg-white text-sm font-medium text-gray-500 hover:bg-gray-50" onclick="ajusterLignes('_-1')">
              <span class="sr-only">Previous</span>
              <svg class="h-5 w-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
                <path fill-rule="evenodd" d="M12.707 5.293a1 1 0 010 1.414L9.414 10l3.293 3.293a1 1 0 01-1.414 1.414l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 0z" clip-rule="evenodd" />
              </svg>
            </button>
            <button class="relative inline-flex items-center px-2 py-2 rounded-r-md border border-gray-300 bg-white text-sm font-medium text-gray-500 hover:bg-gray-50" onclick="ajusterLignes('_+1')">
              <span class="sr-only">Next</span>
              <svg class="h-5 w-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
                <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd" />
              </svg>
            </button>
          </nav>
        </div>
      </div>
    </div>
  </div>
</body>
</html>